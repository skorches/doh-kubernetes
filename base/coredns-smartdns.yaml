apiVersion: apps/v1
kind: Deployment
metadata:
  name: coredns-smartdns
  namespace: doh-system
  labels:
    app.kubernetes.io/name: coredns-smartdns
    app.kubernetes.io/component: dns
    app.kubernetes.io/part-of: doh-smart-dns
spec:
  replicas: 2
  selector:
    matchLabels:
      app.kubernetes.io/name: coredns-smartdns
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxUnavailable: 1
      maxSurge: 1
  template:
    metadata:
      labels:
        app.kubernetes.io/name: coredns-smartdns
        app.kubernetes.io/component: dns
        app.kubernetes.io/part-of: doh-smart-dns
      annotations:
        # Updated by deploy.sh â€” triggers rolling restart on config changes
        checksum/config: "PLACEHOLDER"
    spec:
      # Spread replicas across different nodes when possible
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            - weight: 100
              podAffinityTerm:
                labelSelector:
                  matchLabels:
                    app.kubernetes.io/name: coredns-smartdns
                topologyKey: kubernetes.io/hostname
      # Allow in-flight DNS queries to finish before termination
      terminationGracePeriodSeconds: 30
      containers:
        - name: coredns
          image: coredns/coredns:1.12.0
          args:
            - "-conf"
            - "/etc/coredns/Corefile"
          ports:
            - containerPort: 53
              name: dns-udp
              protocol: UDP
            - containerPort: 53
              name: dns-tcp
              protocol: TCP
            - containerPort: 8080
              name: health
              protocol: TCP
            - containerPort: 8181
              name: ready
              protocol: TCP
            - containerPort: 9153
              name: metrics
              protocol: TCP
          livenessProbe:
            httpGet:
              path: /health
              port: 8080
            initialDelaySeconds: 10
            periodSeconds: 10
            timeoutSeconds: 3
            failureThreshold: 3
          readinessProbe:
            httpGet:
              path: /ready
              port: 8181
            initialDelaySeconds: 5
            periodSeconds: 5
            timeoutSeconds: 2
            failureThreshold: 2
          securityContext:
            runAsNonRoot: true
            runAsUser: 1000
            runAsGroup: 1000
            readOnlyRootFilesystem: true
            allowPrivilegeEscalation: false
            capabilities:
              drop: ["ALL"]
              add: ["NET_BIND_SERVICE"]
          resources:
            requests:
              cpu: 100m
              memory: 64Mi
            limits:
              cpu: 300m
              memory: 256Mi
          volumeMounts:
            - name: coredns-config
              mountPath: /etc/coredns/Corefile
              subPath: Corefile
              readOnly: true
            - name: xbox-hosts
              mountPath: /etc/coredns/xbox-hosts
              subPath: xbox-hosts
              readOnly: true
      volumes:
        - name: coredns-config
          configMap:
            name: coredns-config
        - name: xbox-hosts
          configMap:
            name: xbox-hosts
      # Use Cloudflare/Google DNS for the pod itself (not cluster DNS)
      dnsPolicy: None
      dnsConfig:
        nameservers:
          - "1.1.1.1"
          - "8.8.8.8"
      restartPolicy: Always
---
apiVersion: v1
kind: Service
metadata:
  name: coredns-smartdns
  namespace: doh-system
  labels:
    app.kubernetes.io/name: coredns-smartdns
    app.kubernetes.io/component: dns
    app.kubernetes.io/part-of: doh-smart-dns
spec:
  type: ClusterIP
  selector:
    app.kubernetes.io/name: coredns-smartdns
  ports:
    - port: 53
      targetPort: 53
      protocol: UDP
      name: dns-udp
    - port: 53
      targetPort: 53
      protocol: TCP
      name: dns-tcp
---
# Expose DNS on the node's port 53 for external clients (Xbox, etc.)
apiVersion: v1
kind: Service
metadata:
  name: coredns-smartdns-external
  namespace: doh-system
  labels:
    app.kubernetes.io/name: coredns-smartdns
    app.kubernetes.io/component: dns-external
    app.kubernetes.io/part-of: doh-smart-dns
spec:
  type: NodePort
  selector:
    app.kubernetes.io/name: coredns-smartdns
  ports:
    - port: 53
      targetPort: 53
      nodePort: 30053
      protocol: UDP
      name: dns-udp
    - port: 53
      targetPort: 53
      nodePort: 30054
      protocol: TCP
      name: dns-tcp
